---
CJKmainfont: Source Han Serif CN
data: 2022.09.26
documentclass: article
geometry: margin=3cm
---
# 武汉大学国家网络安全学院教学实验报告

|   课程名称   |  软件安全实验  |   实验日期   | 2022.10.12 |
| :----------: | :------------------: | :----------: | :-------: |
| **实验名称** | **磁盘结构与文件系统** | **授课教师** | **陈泽茂** |
|   **姓名**   |       **学号**       |   **专业**   | **班级**  |
|    郑炳捷    |     2020302181024    |   信息安全   |     2020级1班     |
|    刘莫寒    |    2020302181021     |   信息安全   |     2020级1班     |
|    靖子萸    |    2020302181003     |   信息安全   |     2020级1班     |

## 实验目的及实验内容

### 实验目的

1. 加深对FAT32分区及文件系统格式的理解。
2. 掌握借助WinHex等工具手工定位磁盘文件数据的技能。
3. 通过开发一个磁盘文件数据提取工具，强化编程实践能力。

### 实验内容

- 内容一：手工定位和提取FAT32分区中的文件数据

  在FAT32分区下创建一个不小于10K的Word文档，根据课上介绍的FAT32分区及文件系统知识，必要时自行上网查阅相关资料，借助WinHex或其它十六进制工具，以手工方式从磁盘中逐一找到该文件的各个存储扇区，复制其中的有效内容，并拼接组合成一个与原文档内容相同的完整文档。

- 内容二：编程实现“内容一”的全过程

  输入：某个文件（A）的路径
  
  输出：
  - 该文件的短文件名目录项信息
  - 该文件的簇链
  - 根据上述的文件簇链，从磁盘上提取数据并拼接而得的新文件（B） 
  - 文件A与文件B内容的比较结果（要求二者完全一致）

## 实验环境及实验步骤

### 实验环境

Windows 10（内容一）

WinHex 20.6 SR-1

### 实验步骤

- 内容一：

  在Windows系统下新建虚拟硬盘，新建逻辑分区并将文件系统设为FAT32。在这个新分区内创建目标Word文档，然后用WinHex查看该分区内容，并找到BPB、文件分区表和目标Word文档的地址并分析内容，修改文件分区表和对应的簇，从而达到复制文件的目的。

- 内容二：

  我们将整体功能分为三部分来实现：

  1. 读DBR来确定文件分配表、根目录的位置以及簇和扇区的大小等数据。
  2. 读文件分区表和根目录获取簇链和目录项信息，将它们解析并定位文件。
  3. 提取并拼接获得新文件。


## 实验过程分析

### 概念分析

- FAT32文件系统结构：

  ![FAT32文件系统结构](pictures/FAT32_Struct.jpg)

- DBR中的BIOS参数块（BPB）的重要字段：

  ![BPB](pictures/BPB_Struct.jpg)

- 定位FAT32文件数据流程图：

  ![定位FAT32文件数据流程图](process.png)

- 目录项数据结构重要字段：

  - 短文件名目录项：

    ![短文件名目录项](pictures/short.jpg)

  - 长文件名目录项：

    ![长文件名目录项](pictures/long.jpg)

### 内容一

- 在Windows系统中右键单击计算机，选择管理，然后点击左侧磁盘管理，进入磁盘管理界面。右键单击左侧的磁盘管理，选择创建VHD，选择合适的选项然后创建虚拟硬盘，这个时候能看到界面下方出现了刚出现的虚拟硬盘。右键单击虚拟硬盘的未分配空间，选择新建简单卷，然后设置合适的分区大小（我设置的是64MB），然后将文件系统设置为FAT32。

  ![磁盘管理界面](pictures/DiskManagement.jpg)

- 在新建的G盘中写一个符合要求的Word文档并保存。

  ![文件的属性](pictures/attribute.jpg)

- 打开WinHex，然后选择工具栏中的打开磁盘，选择逻辑分区G，即可看到硬盘的数据。可以看到DBR就在偏移0x0的位置：

  ![DBR](pictures/DBR.jpg)

  分析数据得到下表：

  |   字节偏移   |  字段长度  |   字段内容   | 字段含义 |
  | :----------: | :------------------: | :----------: | :-------: |
  |    0x0B    |     2    |   0x0200   |     每扇区512字节     |
  |    0x0D    |     1    |   0x01   |     每簇1扇区     |
  |    0x0E    |     2    |   0x187E   |     6270个保留扇区     |
  | 0x10 | 1 | 0x02 | 两个文件分区表FAT |
  | 0x20 | 4 | 0x00020000 | 分区占用131072扇区 |
  | 0x24 | 4 | 0x000003C1 | 每个FAT占用961个扇区 |
  | 0x2C | 4 | 0x00000002 | BPB_RootClus = 2 |

  通过上面的数据可以得到：1簇恰好为1扇区，大小为512字节；共6270个保留扇区，每个FAT大小为961扇区，所以FAT1在6270扇区，FAT2在6270+961=7231扇区，根目录在7231+961=8192扇区（簇2）。

  跳转至6270扇区查看FAT1：

  ![FAT1](pictures/FAT1.jpg)

  跳转至8192扇区查看根目录，可以看到test.docx的长文件名目录项：

  ![根目录](pictures/root.jpg)

  结合十六进制数据和WinHex的详细数据区可以看出，我们所创建的test.docx所占用的簇号为0x07至0x1B即簇7至簇27。

  ![簇7、8](pictures/Cluster7.jpg)

  ![修改前的簇27、28](pictures/OldClus27.jpg)

  可以看到该Word文档确实是从簇7开始存储至簇27，并且簇28目前是空的。

  修改文件分区表，新增簇链0x1C至0x30即簇28至簇48，与原文件大小保持一致，然后复制簇7至簇27的所有内容，粘贴到簇28开始处。（下图中蓝色为修改部分）

  ![修改后的FAT1](pictures/NewFAT1.jpg)

  ![修改后的FAT2](pictures/NewFAT2.jpg)

  ![修改后的簇27、28](pictures/NewClus28.jpg)

  在上方菜单栏中选择文件-保存扇区保存刚才的修改，但是发现此时资源管理器中并没有复制出来的新文件（此时没有想起来忘记复制目录项，正确的做法和结果放在故障处理中），于是回到WinHex中，在上方菜单栏中选择工具-磁盘工具-通过文件类型恢复，选择Documents文件类型来恢复数据。然后重新查看资源管理器，发现恢复出了两个Word文档和一个WinHex的log文件。
  
  ![G盘根目录下的文件](pictures/G.jpg)

  对比三个文件的内容，发现它们完全一致，确实成功完全复制。

  ![test文档内容](pictures/testdoc.jpg)

  ![复制文件1](pictures/doc1.jpg)
  
  ![复制文件2](pictures/doc2.jpg)

  推测恢复出两个文件的原因是我同时修改了FAT1和FAT2，而FAT2是FAT1的备份，在扫描硬盘时两个簇链均被识别并恢复成一个文件（当做另一个文件分区表损坏来识别），导致出现了两个恢复文件。于是我将FAT2的对应簇链删除，再次使用恢复文件功能，发现这次只识别出了1个文件头部信息，并且刷新磁盘快照后，FAT2被删除的部分再次恢复，猜想得到验证。

  ![删除FAT2对应簇链的恢复结果](pictures/deleteClusLink.jpg)

### 内容二

- 读取数据所使用的数据结构

```c
//扇区
struct Sector{
  unsigned long read_pos;
  char data[SECTOR_SIZE];
  };

//BPB
struct BPB{
  unsigned short byte_per_sector; // 每扇区字节数
  unsigned char sector_per_cluster; // 每簇扇区数
  unsigned short reserved_sector_cnt; // 保留扇区数目
  unsigned char FAT_cnt; // FAT个数
  unsigned int DBR_byte_size; // DBR分区占字节数
  unsigned int sector_per_FAT; // FAT占用扇区数
  unsigned int BPR_root_clus;
  };

//簇链
struct Cluster{
  unsigned long cluster_no;
  struct Cluster * next_cluster;
  }
```

## 实验结果总结与故障记录

### 内容一未复制目录项

在内容一的实验过程分析中有提到，在保存修改之后并没有找到复制出来的文件，原因是忘记复制目录项，所以在根目录（资源管理器的G盘界面）看不到被复制出来的文件，在后续回顾检查的时候发现并修改，将新的目录项复制到根目录下，并将起始簇号从0x00000007（簇7）改成0x0000001C（簇28）：

![根目录新增目录项](pictures/newCatalog.jpg)

修改完成并保存后打开资源管理器查看结果，发现两个一模一样的test.docx，结果符合预期。

![最终结果](pictures/final.jpg)

### 长文件名目录项解析错误

在调试的过程中发现长文件名目录项解析无论如何都不正确，最后重新阅读代码和FAT32长文件名目录项存储规则时，发现FAT32的长文件名目录项在存储的时候是两字节对应一个字符（Unicode编码），与短文件名目录项一字节一字符不同，而在定义数据结构的时候并没有做出差异处理，对长文件名目录项仍然按一字符一字节解析，故出现错误。下图为长文件名目录项存储示例（同时有一个短文件名目录项来标记起始簇号和文件长度）：

![长文件名目录项存储示例](pictures/diff.jpg)

## 各人贡献与心得体会

通过本次实验，我们对FAT32分区及文件系统格式有了更深刻的理解，并且初步学习了硬盘数据分析工具的使用，完成了简单功能的实现。本次实验中，郑炳捷负责内容一的全部相关内容以及大部分实验报告的编写。刘莫寒负责内容二的代码编写和对代码功能的解释部分。

## 教师评价

![教师评价](pictures/jiaoshi.jpg)